<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0">
<head>
	<title>GCTC Portal Notification</title>
	<link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
	<style>button {padding: 4px 8px; color: white; background-color: #0275d8; border: none; border-radius: 4px; font-family: 'Open Sans', sans-serif; user-select: none;}</style>
</head>
<body style="font-family: 'Open Sans', sans-serif;">
	<center>
		<h2>GCTC Portal Notification Service</h2>
		<div id="init">			
			<p>We will <b>automatically</b> authenticate you based on your primary Google account.<br>If multiple accounts exist on your device, you will be prompted to select one.</p>
			<p>Make sure popups are enabled.</p>
		</div>
		<div id="post_login" style="display: none;">
			<img id="profile_pic" style="border-radius: 50%;" width="100px" height="100px"><br>
			<h3 id="profile_name"></h3>
			<p id="profile_email"></p>
			<!--<button id="enable_push">Enable Notifications</button>-->
		</div>
		<div id="roll_init" style="display: none;">
			<small>It seems that your Roll No. does not exist in our database. We will send you relavent notifications based on your Roll No.</small><br>
			<input type="text" id="roll_no" maxlength="10" placeholder="Roll Number" /> <button id="roll_button">Submit</button>
		</div>
	</center>
</body>
</html>
<script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyDpW1PViiXyP3obr0ijYSg7sw8Lkntm6a0",
    authDomain: "gcetone.firebaseapp.com",
    databaseURL: "https://gcetone.firebaseio.com",
    projectId: "gcetone",
    messagingSenderId: "1059297273439",
    appId: "1:1059297273439:web:a56569478d7c919453ddea"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig)
</script>
<script>
	navigator.serviceWorker.register('./firebase-messaging-sw.js')
	.then((registration) => {
		firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE).then(() => {
			const provider = new firebase.auth.GoogleAuthProvider()
			const messaging = firebase.messaging()
			const db = firebase.firestore()
			messaging.useServiceWorker(registration)

			firebase.auth().signInWithPopup(provider).then((r) => {
				console.log(r)
				uid = r.user.uid
				document.getElementById("init").style.display = "none"
				document.getElementById("post_login").style.display = "block"
				document.getElementById("profile_pic").src = r.user.photoURL
				document.getElementById("profile_name").innerHTML = r.user.displayName
				document.getElementById("profile_email").innerHTML = r.user.email

				messaging.requestPermission().then(() => {
					messaging.getToken().then((token) => {
						console.log("Token", token)
						const collection = db.collection("users")

						collection.doc(r.user.uid).get().then((doc) => {
							if(doc.exists) {
								data = doc.data()
								if(data.roll === undefined) {
									document.getElementById("roll_init").style.display = "block"
									document.getElementById("roll_button").addEventListener('click', () => {
										document.getElementById("roll_button").innerHTML = "Submitting"
										document.getElementById("roll_button").disabled = true

										const roll = document.getElementById("roll_no").value
										collection.doc(r.user.uid).update({
											'roll': roll
										}).then(() => {
											console.log("Roll Number updated successfully")
											document.getElementById("roll_init").style.display = "none"
										});
									})
								}
								else {
									document.getElementById("profile_email").innerHTML += "<br><b>" + data.roll + "</b>"
								}
							}
							else {
								collection.doc(r.user.uid).set({
									'name': r.user.displayName,
									'uid': r.user.uid,
									'fcm_token': token
								}).then(() => console.log("Document successfully written with UID", uid))							
							}
						})
					})
				})

			}).catch((error) => document.getElementById("profile-email").innerHTML = error.message)
		});
	});
</script>
